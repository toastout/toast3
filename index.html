<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ ë‹¨ì–´ í˜•ê´‘íœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-color: #f8f9fa; --text-color: #212529; --border-color: #dee2e6;
      --input-bg: #ffffff; --input-border: #ced4da; --header-bg: #ffffff;
      --preview-bg: #ffffff; --key-color: #495057;
      --btn-bg: #e9ecef; --btn-hover-bg: #dee2e6;
      --accent-btn-bg: #339af0; --accent-btn-hover-bg: #1c7ed6;
    }
    body.dark {
      --bg-color: #121212; --text-color: #e9ecef; --border-color: #343a40;
      --input-bg: #212529; --input-border: #495057; --header-bg: #1c1c1c;
      --preview-bg: #1c1c1c; --key-color: #adb5bd;
      --btn-bg: #343a40; --btn-hover-bg: #495057;
      --accent-btn-bg: #1c7ed6; --accent-btn-hover-bg: #1b6ec2;
    }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 20px;
      background-color: var(--bg-color); color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .container { display: grid; grid-template-columns: 300px 1fr 1fr; gap: 20px; height: calc(100vh - 120px); }
    .panel { background-color: var(--header-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .panel-header h3 { margin: 0; }
    #editor { resize: vertical; font-family: inherit; } /* âœ¨ ê¸€ê¼´ ìƒì†ë°›ë„ë¡ ìˆ˜ì • */
    #editor, #preview { width: 100%; height: 100%; box-sizing: border-box; font-size: 1rem; line-height: 1.7; border: none; background: none; color: inherit; flex-grow: 1; }
    #editor { outline: none; }
    #preview { white-space: pre-wrap; overflow-wrap: break-word; overflow-y: auto; }
    #keyword-list { list-style: none; padding: 0; margin-top: 15px; overflow-y: auto; flex-grow: 1; }
    .keyword-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-radius: 6px; margin-bottom: 8px; background-color: var(--bg-color); }
    .keyword-item span { font-weight: 500; word-break: break-all; }
    .keyword-item input[type="color"] { min-width: 24px; width: 24px; height: 24px; border: none; background: none; cursor: pointer; }
    .keyword-item button { background: none; border: none; color: #fa5252; font-size: 1.2rem; cursor: pointer; }
    #add-keyword-form { display: flex; gap: 8px; }
    #new-keyword { flex-grow: 1; padding: 8px; border: 1px solid var(--input-border); border-radius: 6px; background-color: var(--input-bg); color: inherit; }
    #add-btn { padding: 8px 12px; border: none; border-radius: 6px; background-color: var(--accent-btn-bg); color: #fff; cursor: pointer; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .main-controls { display: flex; gap: 8px; }
    .main-controls button, .keyword-controls button, .panel-controls button {
      border: none; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem;
      font-weight: 600; cursor: pointer; transition: background-color 0.2s, color 0.2s, transform 0.1s;
    }
    .panel-controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .keyword-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border-color); }
    #version-list-container { font-size: 0.9rem; margin-top: 10px; }
    #version-list { max-height: 100px; overflow-y: auto; border: 1px solid var(--border-color); padding: 5px; border-radius: 6px; }
    .version-item { display: flex; justify-content: space-between; align-items: center; padding: 4px; cursor: pointer; }
    .version-item:hover { background-color: var(--btn-bg); }
    .version-item button { font-size: 1rem; background: none; color: #fa5252; padding: 0 5px; }
    .color-palette { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
    .color-swatch { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid var(--border-color); }
    
    .edit-section {
        margin-bottom: 10px;
        padding: 10px;
        background-color: var(--bg-color);
        border-radius: 6px;
    }
    .edit-section h4 {
        margin: 0 0 8px 0;
        font-size: 0.9rem;
        font-weight: 600;
    }
    .edit-form {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .edit-form input {
        flex: 1;
        padding: 8px;
        border: 1px solid var(--input-border);
        border-radius: 6px;
        background-color: var(--input-bg);
        color: inherit;
        font-size: 0.9rem;
    }
    .edit-form button {
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        color: #fff;
        cursor: pointer;
        font-weight: 600;
    }
    #delete-range-btn { background-color: #fa5252; }
    #replace-word-btn { background-color: var(--accent-btn-bg); }
    .edit-form span { font-weight: bold; }

    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; height: auto; gap: 10px; }
      body { padding: 10px; }
      .header { margin-bottom: 10px; }
      #editor { min-height: 250px; }
    }
  </style>
</head>
<body>

  <header class="header">
    <h1>ğŸ“ ë‹¨ì–´ í˜•ê´‘íœ</h1>
    <div class="main-controls">
      <button id="main-link-btn" title="ëŒì•„ê°€ê¸°">ğŸï¸</button>
      <button id="toggleDarkBtn">ğŸŒ—</button>
    </div>
  </header>

  <div class="container" id="container">
    <div class="panel">
      <div class="panel-header"><h3>ë‹¨ì–´ ê´€ë¦¬</h3></div>
      <form id="add-keyword-form" onsubmit="addKeyword(); return false;">
        <input type="text" id="new-keyword" placeholder="ë‹¨ì–´ ì…ë ¥...">
        <input type="color" id="new-color" value="#ffd43b">
        <button id="add-btn" type="submit">+</button>
      </form>
      <div class="color-palette" id="color-palette"></div>
      <ul id="keyword-list"></ul>
      <div class="keyword-controls">
        <button onclick="resetKeywordsToSoi()" title="ğŸ’› Soi (ì§§ì¶œ+Nai) ë¶ˆëŸ¬ì˜¤ê¸°">ğŸ’› Soi ê¸°ë³¸ê°’</button>
        <button onclick="clearAllKeywords()">âœ¨ ì „ì²´ ì‚­ì œ</button>
        <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="exportKeywords()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
        <input type="file" id="fileInput" accept=".txt" style="display: none;">
      </div>
    </div>

    <div class="panel">
       <div class="panel-header">
         <h3>ì›ë³¸</h3>
         <div class="panel-controls">
           <button onclick="pasteToEditor(this)">ğŸ“ ë¶™ì—¬ë„£ê¸°</button>
           <button onclick="copyEditor(this)">ğŸ“‹ ë³µì‚¬</button>
           <button onclick="saveVersion()">ğŸ’¾ ì €ì¥</button>
           <button onclick="clearEditor()">ğŸ§¹ ì´ˆê¸°í™”</button>
           <button id="translate-ko-en-btn" title="í•œâ†’ì˜ ë²ˆì—­">ğŸ‡¬ğŸ‡§</button>
           <button id="translate-en-ko-btn" title="ì˜â†’í•œ ë²ˆì—­">ğŸ‡°ğŸ‡·</button>
           <button id="spell-check-btn" title="ë§ì¶¤ë²• ê²€ì‚¬">ğŸ”</button>
         </div>
       </div>
       
       <div class="edit-section">
           <h4>ë²”ìœ„ ì‚­ì œ</h4>
           <div class="edit-form">
               <input type="text" id="delete-start" placeholder="ì‹œì‘ ë‹¨ì–´">
               <span>â†’</span>
               <input type="text" id="delete-end" placeholder="ë ë‹¨ì–´">
               <button id="delete-range-btn">ì‚­ì œ</button>
           </div>
       </div>
       
       <div class="edit-section">
           <h4>ë‹¨ì–´ ì¹˜í™˜</h4>
           <div class="edit-form">
               <input type="text" id="replace-find" placeholder="ì°¾ì„ ë‹¨ì–´">
               <span>â†’</span>
               <input type="text" id="replace-with" placeholder="ë°”ê¿€ ë‹¨ì–´">
               <button id="replace-word-btn">ì¹˜í™˜</button>
           </div>
       </div>

      <textarea id="editor" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
      <div id="version-list-container">
        <strong>ë²„ì „ ëª©ë¡:</strong>
        <div id="version-list"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header"><h3>ë¯¸ë¦¬ë³´ê¸°</h3></div>
      <div id="preview"></div>
    </div>
  </div>

  <script>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const newKeywordInput = document.getElementById('new-keyword');
    const newColorInput = document.getElementById('new-color');
    const keywordList = document.getElementById('keyword-list');
    const fileInput = document.getElementById('fileInput');
    const versionList = document.getElementById('version-list');
    const deleteRangeBtn = document.getElementById('delete-range-btn');
    const replaceWordBtn = document.getElementById('replace-word-btn');

    let keywords = [];
    
    const defaultKeywords = [
        { keyword: "<Thoughts>", color: "#a5d8ff" },
        { keyword: "</Thoughts>", color: "#a5d8ff" },
        { keyword: "[Char1]", color: "#b2f2bb" },
        { keyword: "[Char2]", color: "#ffc9c9" },
        { keyword: "[Place]", color: "#ffec99" },
        { keyword: "[Scene]", color: "#d0bfff" },
        { keyword: "[Angle]", color: "#ffc078" },
    ];

    function renderKeywords() {
      keywordList.innerHTML = '';
      keywords.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'keyword-item';
        li.innerHTML = `
          <span>${escapeHtml(item.keyword)}</span>
          <div>
            <input type="color" value="${item.color}" onchange="updateColor(${index}, this.value)">
            <button onclick="deleteKeyword(${index})">&times;</button>
          </div>
        `;
        keywordList.appendChild(li);
      });
      updatePreview();
      saveKeywords();
    }
    
    function addKeyword() {
      const keyword = newKeywordInput.value.trim();
      if (keyword && !keywords.some(item => item.keyword === keyword)) {
        keywords.push({ keyword, color: newColorInput.value });
        newKeywordInput.value = '';
        renderKeywords();
      }
    }

    function deleteKeyword(index) {
      keywords.splice(index, 1);
      renderKeywords();
    }

    function updateColor(index, color) {
      keywords[index].color = color;
      updatePreview();
      saveKeywords();
    }

    function escapeHtml(text) {
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function updatePreview() {
        let text = editor.value;
        if (keywords.length === 0) {
            preview.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
            return;
        }

        const allMatches = [];
        keywords.forEach(item => {
            const regex = new RegExp(escapeRegExp(item.keyword), 'g');
            let match;
            while ((match = regex.exec(text)) !== null) {
                allMatches.push({
                    start: match.index,
                    end: match.index + match[0].length,
                    color: item.color,
                    keyword: match[0]
                });
            }
        });

        allMatches.sort((a, b) => a.start - b.start);

        let highlightedHtml = '';
        let lastIndex = 0;
        allMatches.forEach(match => {
            highlightedHtml += escapeHtml(text.substring(lastIndex, match.start));
            // âœ¨ í˜•ê´‘íœ í…ìŠ¤íŠ¸ êµµê²Œ ìˆ˜ì •
            highlightedHtml += `<mark style="background-color:${match.color}; color: #000; padding: 2px 0; border-radius: 3px; font-weight: 600;">${escapeHtml(match.keyword)}</mark>`;
            lastIndex = match.end;
        });
        highlightedHtml += escapeHtml(text.substring(lastIndex));
        
        preview.innerHTML = highlightedHtml.replace(/\n/g, '<br>');
    }
    
    function deleteRange() {
        const text = editor.value;
        const startMarker = document.getElementById('delete-start').value;
        const endMarker = document.getElementById('delete-end').value;

        if (!startMarker || !endMarker) {
            alert('ì‹œì‘ ë‹¨ì–´ì™€ ë ë‹¨ì–´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const startRegex = new RegExp(escapeRegExp(startMarker), 'i');
        const startMatch = text.match(startRegex);

        if (!startMatch) {
            alert(`ì‹œì‘ ë‹¨ì–´("${startMarker}")ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        const startIndex = startMatch.index;
        const searchFromIndex = startIndex + startMatch[0].length;
        const textAfterStart = text.substring(searchFromIndex);
        
        const endRegex = new RegExp(escapeRegExp(endMarker), 'i');
        const endMatch = textAfterStart.match(endRegex);

        if (!endMatch) {
            alert(`ì‹œì‘ ë‹¨ì–´ ì´í›„ì— ë ë‹¨ì–´("${endMarker}")ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        const endIndex = endMatch.index + searchFromIndex;
        const endOfDeletion = endIndex + endMatch[0].length;
        let newText = text.substring(0, startIndex) + text.substring(endOfDeletion);
        
        newText = newText.replace(/(\r\n|\n|\r){2,}/g, '\n');
        newText = newText.replace(/ {2,}/g, ' '); // âœ¨ ì—°ì† ê³µë°± 1ê°œë¡œ ìˆ˜ì •
        newText = newText.trim();

        editor.value = newText;
        updatePreview();
        localStorage.setItem('highlighter_text', editor.value);
    }
    
    function replaceWords() {
        const findText = document.getElementById('replace-find').value;
        const replaceText = document.getElementById('replace-with').value;

        if (!findText) {
            alert('ì°¾ì„ ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const findRegex = new RegExp(escapeRegExp(findText), 'gi');
        const newText = editor.value.replace(findRegex, replaceText);

        if (editor.value === newText) {
            alert(`"${findText}"ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        editor.value = newText;
        updatePreview();
        localStorage.setItem('highlighter_text', editor.value);
    }


    function saveKeywords() {
      localStorage.setItem('highlighter_keywords', JSON.stringify(keywords));
    }

    function loadKeywords() {
      const saved = localStorage.getItem('highlighter_keywords');
      if (saved) {
        keywords = JSON.parse(saved);
      } else {
        keywords = [...defaultKeywords];
      }
      renderKeywords();
    }
    
    function resetKeywordsToSoi() {
        if (confirm('í˜„ì¬ ë‹¨ì–´ ëª©ë¡ì„ Soi ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            keywords = [...defaultKeywords];
            renderKeywords();
        }
    }
    
    function clearAllKeywords() {
        if (confirm('ì •ë§ë¡œ ëª¨ë“  ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
            keywords = [];
            renderKeywords();
        }
    }

    function exportKeywords() {
        const text = keywords.map(k => `${k.keyword},${k.color}`).join('\n');
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'keywords.txt';
        a.click();
        URL.revokeObjectURL(url);
    }

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').filter(line => line.trim() !== '');
            keywords = lines.map(line => {
                const parts = line.split(',');
                return { keyword: (parts[0] || '').trim(), color: (parts[1] || '#ffd43b').trim() };
            });
            renderKeywords();
        };
        reader.readAsText(file);
        event.target.value = '';
    });
    
    const VERSION_STORAGE_KEY = 'highlighter_versions';
    function saveVersion() {
      const content = editor.value.trim();
      if (!content) { alert('ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      let versions = JSON.parse(localStorage.getItem(VERSION_STORAGE_KEY) || '[]');
      const timestamp = new Date().toLocaleString('ko-KR');
      versions.unshift({ time: timestamp, text: content });
      if (versions.length > 20) versions.pop();
      localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versions));
      renderVersionList();
    }
    
    function renderVersionList() {
      let versions = JSON.parse(localStorage.getItem(VERSION_STORAGE_KEY) || '[]');
      versionList.innerHTML = versions.length === 0 ? '<em>ì €ì¥ëœ ë²„ì „ ì—†ìŒ</em>' : '';
      versions.forEach((v, idx) => {
        const div = document.createElement('div');
        div.className = 'version-item';
        div.innerHTML = `<span>${v.time}</span><button onclick="deleteVersion(${idx})">&times;</button>`;
        div.onclick = (e) => {
            if (e.target.tagName === 'BUTTON') return;
            if (confirm('ì´ ë²„ì „ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                editor.value = v.text;
                updatePreview();
            }
        };
        versionList.appendChild(div);
      });
    }

    function deleteVersion(idx) {
        event.stopPropagation();
        let versions = JSON.parse(localStorage.getItem(VERSION_STORAGE_KEY) || '[]');
        if (confirm('ì´ ë²„ì „ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            versions.splice(idx, 1);
            localStorage.setItem(VERSION_STORAGE_KEY, JSON.stringify(versions));
            renderVersionList();
        }
    }

    function clearEditor() {
      if (confirm('ì •ë§ë¡œ ì›ë³¸ë¥¼ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        editor.value = '';
        updatePreview();
        localStorage.setItem('highlighter_text', '');
      }
    }
    
    function showFeedback(btn, message, isSuccess) {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = isSuccess ? `âœ… ${message}` : `âŒ ${message}`;
        setTimeout(() => {
            btn.innerHTML = originalHtml;
        }, 1500);
    }

    function copyEditor(btn) {
        if(!editor.value) return;
        navigator.clipboard.writeText(editor.value).then(() => {
            showFeedback(btn, 'ë³µì‚¬ ì™„ë£Œ', true);
        }).catch(() => {
            showFeedback(btn, 'ë³µì‚¬ ì‹¤íŒ¨', false);
        });
    }
    
    async function pasteToEditor(btn) {
        try {
            const text = await navigator.clipboard.readText();
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + text.length;
            editor.focus();
            updatePreview();
            localStorage.setItem('highlighter_text', editor.value);
            showFeedback(btn, 'ì™„ë£Œ', true);
        } catch (err) {
            showFeedback(btn, 'ì‹¤íŒ¨', false);
        }
    }

    document.getElementById('main-link-btn').addEventListener('click', () => {
        window.location.href = "https://toastout.github.io/toast/";
    });

    document.getElementById('toggleDarkBtn').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('highlighter_darkmode', document.body.classList.contains('dark'));
    });
    
    document.getElementById('translate-ko-en-btn').addEventListener('click', () => {
        const text = editor.value.trim();
        if (!text) return;
        window.open(`https://translate.google.com/?sl=ko&tl=en&text=${encodeURIComponent(text)}&op=translate`, '_blank');
    });

    document.getElementById('translate-en-ko-btn').addEventListener('click', () => {
        const text = editor.value.trim();
        if (!text) return;
        window.open(`https://translate.google.com/?sl=en&tl=ko&text=${encodeURIComponent(text)}&op=translate`, '_blank');
    });

    document.getElementById('spell-check-btn').addEventListener('click', () => {
        const text = editor.value.trim();
        if (!text) return;
        try {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert('ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë§ì¶¤ë²• ê²€ì‚¬ê¸° ì‚¬ì´íŠ¸ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
            window.open('https://nara-speller.co.kr/speller', '_blank');
        } catch(err) {
            alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    });

    function createColorPalette() {
        const paletteContainer = document.getElementById('color-palette');
        const colors = ['#fa5252', '#e64980', '#be4bdb', '#7950f2', '#4c6ef5', '#228be6', '#15aabf', '#12b886', '#40c057', '#82c91e', '#fab005', '#fd7e14'];
        colors.forEach(color => {
            const swatch = document.createElement('div');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = color;
            swatch.onclick = () => { newColorInput.value = color; };
            paletteContainer.appendChild(swatch);
        });
    }
    
    deleteRangeBtn.addEventListener('click', deleteRange);
    replaceWordBtn.addEventListener('click', replaceWords);

    window.onload = () => {
        if (localStorage.getItem('highlighter_darkmode') === 'true') {
            document.body.classList.add('dark');
        }
        loadKeywords();
        editor.value = localStorage.getItem('highlighter_text') || '';
        updatePreview();
        renderVersionList();
        createColorPalette();
    };
    
    editor.addEventListener('input', () => {
      updatePreview();
      localStorage.setItem('highlighter_text', editor.value);
    });
  </script>
</body>
</html>

